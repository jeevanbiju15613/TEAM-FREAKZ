<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - NearMe</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .login-container { max-width:400px; margin:80px auto; background:white; padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .login-container h2 { text-align:center; color:#4a7fe3; margin-bottom:20px; }
    .login-form { display:flex; flex-direction:column; gap:15px; }
    .login-form input, .login-form select { padding:12px; border-radius:6px; border:1px solid #ccc; }
    .login-form button, .direct-btn { padding:12px; border:none; border-radius:6px; background:#4a7fe3; color:white; cursor:pointer; }
    .login-form button:hover, .direct-btn:hover { background:#365dcf; }
    .login-container p { text-align:center; margin-top:10px; font-size:0.9rem; color:#555; }
  </style>
</head>
<body>
  <div class="logo-title">
    <img src="Ellipse 4.png" alt="Worker Logo">
    <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
  </div>

  <div class="login-container">
    <h2>Login</h2>
    <form class="login-form" id="loginForm">
      <label for="role">MY ROLE:</label>
      <select id="role">
        <option value="user">User</option>
        <option value="worker">Worker</option>
      </select>

      <input type="text" id="username" placeholder="Username or Email" required>
      <input type="password" id="password" placeholder="Password" required>

      <button type="submit">Login</button>
    </form>

    <button class="direct-btn" onclick="window.location.href='1.html'">Go to Services</button>
    <p>Don't have an account? <a href="register.html">Register</a></p>
  </div>

  <script>
    // Login handler: checks stored users array (localStorage["users"])
    document.getElementById("loginForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const role = document.getElementById("role").value;
      const credential = document.getElementById("username").value.trim(); // username or email
      const password = document.getElementById("password").value.trim();

      if (!credential || !password) {
        alert("Please enter username/email and password.");
        return;
      }

      const users = JSON.parse(localStorage.getItem("users")) || [];

      // find by username OR by email
      const user = users.find(u =>
        (u.username && u.username.toLowerCase() === credential.toLowerCase()) ||
        (u.email && u.email.toLowerCase() === credential.toLowerCase())
      );

      if (!user) {
        // Not found => ask to register
        const goReg = confirm("Account not found. Do you want to register?");
        if (goReg) window.location.href = "register.html";
        return;
      }

      if (user.password !== password) {
        alert("Incorrect password. Try again.");
        return;
      }

      // Success: mark session (keeps compatibility with older pages)
      localStorage.setItem("loggedIn", "true");
      localStorage.setItem("loggedInUser", user.email); // canonical session (email)
      localStorage.setItem("username", user.username || "");
      localStorage.setItem("role", user.role || "user");

      // redirect handling (support encoded redirect param)
      const params = new URLSearchParams(window.location.search);
      const redirectParam = params.get("redirect");
      if (redirectParam) {
        try {
          const dest = decodeURIComponent(redirectParam);
          window.location.href = dest;
          return;
        } catch (err) {
          // fallback to raw
          window.location.href = redirectParam;
          return;
        }
      }

      // default landing
      if (user.role === "worker") {
        window.location.href = "worker-dashboard.html";
      } else {
        window.location.href = "ar.html";
      }
    });
  </script>
</body>
</html>
