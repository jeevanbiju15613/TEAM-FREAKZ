<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login - NearMe</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5; 
        }
        
        .background-slot {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('login-bg.jpg') no-repeat center center/cover;
            filter: brightness(0.7); 
            z-index: -1;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .logo-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            color: white; 
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            font-size: 1.5em; 
        }

        .logo-title img {
            width: 40px; 
            height: 40px;
        }
        
        .login-container { 
            max-width: 400px; 
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            padding: 35px; 
            border-radius: 12px; 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .login-container h2 { 
            text-align: center; 
            color: #2b5bcf;
            margin-bottom: 25px; 
            font-weight: 600;
        }
        
        .login-form { 
            display: flex; 
            flex-direction: column; 
            gap: 18px; 
        }
        
        .login-form label {
            font-size: 0.9rem;
            color: #555;
            font-weight: 500;
            display: none; /* Hide label for removed role selector */
        }

        .login-form input, 
        .login-form select { 
            padding: 14px 15px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .login-form input:focus,
        .login-form select:focus {
            border-color: #2b5bcf;
            outline: none;
            box-shadow: 0 0 0 3px rgba(43, 91, 207, 0.2);
        }

        .login-form button, 
        .direct-btn { 
            padding: 14px; 
            border: none; 
            border-radius: 8px; 
            background: #2b5bcf;
            color: white; 
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, transform 0.1s;
        }

        .login-form button:hover, 
        .direct-btn:hover { 
            background: #1d3e91; 
            transform: translateY(-1px);
        }

        .login-container p { 
            text-align: center; 
            margin-top: 20px; 
            font-size: 0.95rem; 
            color: #666; 
        }

        .login-container p a {
            color: #2b5bcf;
            text-decoration: none;
            font-weight: 600;
        }

        .login-container p a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="background-slot"></div>

    <div class="page-wrapper">
        <div class="logo-title">
            <img src="Ellipse 4.png" alt="Worker Logo">
            <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
        </div>

        <div class="login-container">
            <h2>Login</h2>
            <form class="login-form" id="loginForm">
                <input type="text" id="username" placeholder="Username or Email" required>
                <input type="password" id="password" placeholder="Password" required>

                <button type="submit">Login</button>
            </form>

            <button class="direct-btn" onclick="window.location.href='1.html'">Go to Services</button>
            <p>Don't have an account? <a href="register.html">Register</a></p>
        </div>
    </div>

<script>
    document.getElementById("loginForm").addEventListener("submit", function(event) {
        event.preventDefault();

        // The 'role' variable is now irrelevant at the start, as it is determined later
        const credential = document.getElementById("username").value.trim(); 
        const password = document.getElementById("password").value.trim();

        if (!credential || !password) {
            alert("Please enter username/email and password.");
            return;
        }

        const users = JSON.parse(localStorage.getItem("users")) || [];

        // find by username OR by email
        const user = users.find(u =>
            (u.username && u.username.toLowerCase() === credential.toLowerCase()) ||
            (u.email && u.email.toLowerCase() === credential.toLowerCase())
        );

        if (!user) {
            const goReg = confirm("Account not found. Do you want to register?");
            if (goReg) window.location.href = "register.html";
            return;
        }

        if (user.password !== password) {
            alert("Incorrect password. Try again.");
            return;
        }

        // --- SUCCESSFUL LOGIN ---
        
        // Use the role found in the stored user data to set the session and redirect.
        const userRole = user.role || "user"; 

        // ✅ Store session
        localStorage.setItem("loggedIn", "true");
        localStorage.setItem("loggedInUser", user.email); 
        localStorage.setItem("username", user.username || "");
        localStorage.setItem("role", userRole); // Use the stored role

        // ✅ Also store profile data
        const profileKey = `userData_${user.username || user.email}`;
        const profileData = {
            name: user.username || "",
            email: user.email || credential,
            phone: user.phone || "",
            address: user.address || ""
        };
        localStorage.setItem(profileKey, JSON.stringify(profileData));

        // ✅ Redirect
        const params = new URLSearchParams(window.location.search);
        const redirectParam = params.get("redirect");
        
        if (redirectParam) {
            // Redirect to a specific page if requested (e.g., after trying to book a service)
            try {
                const dest = decodeURIComponent(redirectParam);
                window.location.href = dest;
                return;
            } catch (err) {
                window.location.href = redirectParam;
                return;
            }
        }

        // Direct to the correct dashboard based on the stored userRole
        if (userRole === "worker") {
            window.location.href = "worker-dashboard.html";
        } else {
            // Default and 'user' role redirect
            window.location.href = "ar.html"; // Redirecting to 1.html (the main services page)
        }
    });
</script>

</body>
</html>