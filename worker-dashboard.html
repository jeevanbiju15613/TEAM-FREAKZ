<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker Dashboard - NearMe</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f9f9f9; }
    header { background:#4a7fe3; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:10px 20px; }
    .nav-right { display:flex; gap:15px; align-items:center; }
    .logout-btn { background:#e63946; border:none; border-radius:6px; padding:6px 14px; color:#fff; cursor:pointer; }
    .logout-btn:hover { background:#c92a36; }
    .notification-bar { background:#fffae6; padding:10px 20px; border-bottom:1px solid #ddd; }
    .container { max-width:900px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .calendar-list { list-style:none; padding:0; margin:0; }
    .calendar-list li { padding:10px; margin-bottom:8px; background:#f4f6fb; border-radius:6px; }
    .availability-container { margin-top:20px; }
    .availability-slot { display:flex; gap:10px; align-items:center; margin-bottom:6px; }
    .add-slot-btn, .delete-slot-btn, .generate-weekly-btn { padding:6px 14px; border:none; border-radius:6px; cursor:pointer; background:#4a7fe3; color:white; transition: background 0.3s; }
    .add-slot-btn:hover, .delete-slot-btn:hover, .generate-weekly-btn:hover { background:#365dcf; }
    input[type="date"], input[type="time"] { padding:6px 8px; margin-right:6px; border-radius:6px; border:1px solid #ccc; }
    .weekdays { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0; }
    .weekdays label { background:#eef2fb; padding:8px 12px; border-radius:6px; cursor:pointer; transition: background 0.3s; }
    .weekdays input[type="checkbox"] { margin-right:6px; }
    .weekdays label:hover { background:#dce4fa; }
    h4 { margin-top:25px; color:#333; }
  </style>
</head>
<body>

<header>
  <div class="logo-title">
    <img src="Ellipse 4.png" alt="Worker Logo" width="60">
    <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
  </div>
  <div class="nav-right">
    <span id="workerNameRole">Welcome, Worker</span>
    <a href="worker-profile.html">üë§ My Profile</a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="notification-bar" id="notifBar">No new notifications.</div>

<div class="container">
  <h2>üìÖ Upcoming Bookings</h2>
  <ul id="bookingList" class="calendar-list"></ul>

  <h3>Manage Availability</h3>

  <!-- Weekly Scheduler -->
  <div class="availability-container">
    <h4>üóìÔ∏è Set Weekly Availability</h4>
    <p style="color:#666;">Select days and times to auto-generate availability slots for the next 3 weeks.</p>

    <div class="weekdays">
      <label><input type="checkbox" value="1">Mon</label>
      <label><input type="checkbox" value="2">Tue</label>
      <label><input type="checkbox" value="3">Wed</label>
      <label><input type="checkbox" value="4">Thu</label>
      <label><input type="checkbox" value="5">Fri</label>
      <label><input type="checkbox" value="6">Sat</label>
      <label><input type="checkbox" value="0">Sun</label>
    </div>

    <div style="margin:10px 0;">
      <label>Start Time:</label>
      <input type="time" id="weekStart" min="07:00" max="21:00">
      <label>End Time:</label>
      <input type="time" id="weekEnd" min="07:00" max="21:00">
    </div>

    <button class="generate-weekly-btn" id="generateWeeklyBtn">Generate Weekly Schedule</button>

    <hr style="margin:25px 0;">

    <!-- Single Slot Adder -->
    <h4>‚ûï Add Single Availability Slot</h4>
    <input type="date" id="availDate">
    <input type="time" id="availTime" min="07:00" max="21:00">
    <button class="add-slot-btn" id="addSlotBtn">Add Slot</button>

    <div id="availabilityList" style="margin-top:15px;"></div>
  </div>
</div>

<script>
function getCurrentWorker() {
  const email = localStorage.getItem("loggedInUser");
  if (!email) return null;
  const users = JSON.parse(localStorage.getItem("users")) || [];
  return users.find(u => u.email === email && u.role === "worker");
}

function logout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("loggedInUser");
  localStorage.removeItem("username");
  localStorage.removeItem("role");
  window.location.href = "login.html";
}

function renderAvailability(worker) {
  const listDiv = document.getElementById("availabilityList");
  listDiv.innerHTML = "";
  if (!worker.availability || worker.availability.length === 0) {
    listDiv.innerHTML = "<p>No available slots</p>";
    return;
  }
  worker.availability.forEach((slot, index) => {
    const div = document.createElement("div");
    div.className = "availability-slot";
    div.innerHTML = `<span>${slot.replace("T", " ")}</span> 
                     <button class="delete-slot-btn" data-index="${index}">Delete</button>`;
    listDiv.appendChild(div);
  });
}

function loadDashboard() {
  const worker = getCurrentWorker();
  if (!worker) {
    alert("You must login first!");
    window.location.href = "login.html";
    return;
  }

  let categories = "";
  if (worker.categories && worker.categories.length > 0) {
    categories = worker.categories.join(", ");
  } else if (worker.service) {
    categories = worker.service; 
  } else if (worker.role) {
    categories = worker.role;
  }
  document.getElementById("workerNameRole").textContent =
    `Welcome, ${worker.username || worker.name} (${categories})`;

  const bookings = JSON.parse(localStorage.getItem("bookings_" + worker.email)) || [];
  const list = document.getElementById("bookingList");
  list.innerHTML = "";
  if (bookings.length === 0) {
    list.innerHTML = "<li>No bookings assigned yet.</li>";
  } else {
    bookings.forEach(b => {
      const li = document.createElement("li");
      li.textContent = `${b.date} - ${b.time} - ${b.service} for ${b.user}`;
      list.appendChild(li);
    });
  }

  const notif = JSON.parse(localStorage.getItem("notifications_" + worker.email)) || [];
  document.getElementById("notifBar").textContent =
    notif.length > 0 ? `üîî ${notif[notif.length-1]}` : "No new notifications.";

  renderAvailability(worker);
}

// Add single slot
document.getElementById("addSlotBtn").addEventListener("click", () => {
  const worker = getCurrentWorker();
  if (!worker) return;

  const date = document.getElementById("availDate").value;
  const time = document.getElementById("availTime").value;

  if (!date || !time) {
    alert("‚ö†Ô∏è Select both date and time.");
    return;
  }

  if (time < "07:00" || time > "21:00") {
    alert("‚ö†Ô∏è Please select a time between 07:00 and 21:00.");
    return;
  }

  const slot = `${date}T${time}`;
  worker.availability = worker.availability || [];
  if (worker.availability.includes(slot)) {
    alert("‚ö†Ô∏è This slot already exists.");
    return;
  }

  worker.availability.push(slot);

  const users = JSON.parse(localStorage.getItem("users")) || [];
  const index = users.findIndex(u => u.email === worker.email);
  users[index] = worker;
  localStorage.setItem("users", JSON.stringify(users));

  renderAvailability(worker);
  document.getElementById("availDate").value = "";
  document.getElementById("availTime").value = "";
});

// Delete slot
document.getElementById("availabilityList").addEventListener("click", (e) => {
  if (e.target.classList.contains("delete-slot-btn")) {
    const worker = getCurrentWorker();
    if (!worker) return;
    const idx = parseInt(e.target.dataset.index);
    worker.availability.splice(idx, 1);

    const users = JSON.parse(localStorage.getItem("users")) || [];
    users[users.findIndex(u => u.email === worker.email)] = worker;
    localStorage.setItem("users", JSON.stringify(users));

    renderAvailability(worker);
  }
});

// Generate weekly schedule
document.getElementById("generateWeeklyBtn").addEventListener("click", () => {
  const worker = getCurrentWorker();
  if (!worker) return;

  const startTime = document.getElementById("weekStart").value;
  const endTime = document.getElementById("weekEnd").value;

  if (!startTime || !endTime) {
    alert("‚ö†Ô∏è Please select start and end times.");
    return;
  }

  if (startTime < "07:00" || endTime > "21:00") {
    alert("‚ö†Ô∏è Allowed working hours are between 07:00 and 21:00.");
    return;
  }

  if (endTime <= startTime) {
    alert("‚ö†Ô∏è End time must be after start time.");
    return;
  }

  const selectedDays = Array.from(document.querySelectorAll(".weekdays input:checked"))
    .map(cb => parseInt(cb.value));
  if (selectedDays.length === 0) {
    alert("‚ö†Ô∏è Please select at least one day.");
    return;
  }

  worker.availability = worker.availability || [];
  const today = new Date();

  for (let week = 0; week < 3; week++) {
    for (let day = 0; day < 7; day++) {
      const currentDate = new Date(today);
      currentDate.setDate(today.getDate() + week * 7 + day);
      if (selectedDays.includes(currentDate.getDay())) {
        const dateStr = currentDate.toISOString().split("T")[0];
        const startSlot = `${dateStr}T${startTime}`;
        const endSlot = `${dateStr}T${endTime}`;
        if (!worker.availability.includes(startSlot))
          worker.availability.push(startSlot);
        if (!worker.availability.includes(endSlot))
          worker.availability.push(endSlot);
      }
    }
  }

  const users = JSON.parse(localStorage.getItem("users")) || [];
  users[users.findIndex(u => u.email === worker.email)] = worker;
  localStorage.setItem("users", JSON.stringify(users));

  renderAvailability(worker);
  alert("‚úÖ Weekly schedule generated for the next 3 weeks!");
});

window.onload = loadDashboard;
</script>

</body>
</html>
