<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker Dashboard - NearMe</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f9f9f9; }
    header { background:#4a7fe3; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:10px 20px; }
    .nav-right { display:flex; gap:15px; align-items:center; }
    .logout-btn { background:#e63946; border:none; border-radius:6px; padding:6px 14px; color:#fff; cursor:pointer; }
    .logout-btn:hover { background:#c92a36; }
    .notification-bar { background:#fffae6; padding:10px 20px; border-bottom:1px solid #ddd; }
    .container { max-width:900px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .calendar-list { list-style:none; padding:0; margin:0; }
    .calendar-list li { padding:10px; margin-bottom:8px; background:#f4f6fb; border-radius:6px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; }
    .cancel-btn, .details-btn { border:none; border-radius:6px; padding:6px 10px; cursor:pointer; color:#fff; }
    .cancel-btn { background:#e63946; }
    .cancel-btn:hover { background:#c92a36; }
    .details-btn { background:#4a7fe3; }
    .details-btn:hover { background:#365dcf; }
    .availability-container { margin-top:20px; }
    .availability-slot { display:flex; gap:10px; align-items:center; margin-bottom:6px; }
    .add-slot-btn, .delete-slot-btn, .generate-weekly-btn { padding:6px 14px; border:none; border-radius:6px; cursor:pointer; background:#4a7fe3; color:white; transition: background 0.3s; }
    .add-slot-btn:hover, .delete-slot-btn:hover, .generate-weekly-btn:hover { background:#365dcf; }
    input[type="date"], input[type="time"] { padding:6px 8px; margin-right:6px; border-radius:6px; border:1px solid #ccc; }
    .weekdays { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0; }
    .weekdays label { background:#eef2fb; padding:8px 12px; border-radius:6px; cursor:pointer; transition: background 0.3s; }
    .weekdays input[type="checkbox"] { margin-right:6px; }
    .weekdays label:hover { background:#dce4fa; }
    h4 { margin-top:25px; color:#333; }

    /* Modal Styling */
    .modal {
      display:none;
      position:fixed;
      z-index:999;
      left:0; top:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
    }
    .modal-content {
      background:#fff;
      border-radius:10px;
      padding:20px;
      width:90%;
      max-width:400px;
      box-shadow:0 4px 10px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from {opacity:0; transform:scale(0.9);} to {opacity:1; transform:scale(1);} }
    .modal-content h3 { margin-top:0; color:#4a7fe3; }
    .modal-content p { margin:8px 0; color:#333; }
    .modal-content a { color:#1a73e8; text-decoration:none; }
    .modal-content a:hover { text-decoration:underline; }
    .close-btn {
      background:#e63946;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:6px 12px;
      margin-top:15px;
      float:right;
      cursor:pointer;
    }
  </style>
</head>
<body>

<header>
  <div class="logo-title">
    <img src="Ellipse 4.png" alt="Worker Logo" width="60">
    <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
  </div>
  <div class="nav-right">
    <span id="workerNameRole">Welcome, Worker</span>
    <a href="worker-profile.html">üë§ My Profile</a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="notification-bar" id="notifBar">No new notifications.</div>

<div class="container">
  <h2>üìÖ Upcoming Bookings</h2>
  <ul id="bookingList" class="calendar-list"></ul>

  <h3>Manage Availability</h3>
  <div class="availability-container">
    <h4>üóìÔ∏è Set Weekly Availability</h4>
    <p style="color:#666;">Select days and times to auto-generate hourly availability slots for the next 3 weeks.</p>

    <div class="weekdays">
      <label><input type="checkbox" value="1">Mon</label>
      <label><input type="checkbox" value="2">Tue</label>
      <label><input type="checkbox" value="3">Wed</label>
      <label><input type="checkbox" value="4">Thu</label>
      <label><input type="checkbox" value="5">Fri</label>
      <label><input type="checkbox" value="6">Sat</label>
      <label><input type="checkbox" value="0">Sun</label>
    </div>

    <div style="margin:10px 0;">
      <label>Start Time:</label>
      <input type="time" id="weekStart" min="07:00" max="21:00">
      <label>End Time:</label>
      <input type="time" id="weekEnd" min="07:00" max="21:00">
    </div>

    <button class="generate-weekly-btn" id="generateWeeklyBtn">Generate Weekly Schedule</button>
    <hr style="margin:25px 0;">

    <h4>‚ûï Add Single Availability Slot</h4>
    <input type="date" id="availDate">
    <input type="time" id="availTime" min="07:00" max="21:00">
    <button class="add-slot-btn" id="addSlotBtn">Add Slot</button>
    <div id="availabilityList" style="margin-top:15px;"></div>
  </div>
</div>

<!-- üì¶ Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <h3>Booking Details</h3>
    <p id="modalAddress">üìç Address: </p>
    <p id="modalPhone">üìû Phone: </p>
    <p id="modalMap">üåê Map: <a href="#" target="_blank">View Location</a></p>
    <button class="close-btn" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
function getCurrentWorker() {
  const email = localStorage.getItem("loggedInUser");
  if (!email) return null;
  const users = JSON.parse(localStorage.getItem("users")) || [];
  return users.find(u => u.email === email && u.role === "worker");
}

function logout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("loggedInUser");
  localStorage.removeItem("username");
  localStorage.removeItem("role");
  window.location.href = "login.html";
}

function renderBookings(worker) {
  const list = document.getElementById("bookingList");
  list.innerHTML = "";
  const bookings = JSON.parse(localStorage.getItem("bookings_" + worker.email)) || [];
  if (bookings.length === 0) {
    list.innerHTML = "<li>No bookings assigned yet.</li>";
    return;
  }

  bookings.forEach((b, index) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <span>${b.date} - ${b.time} (${b.duration || "1 hour"}) - ${b.service} for ${b.user}</span>
      <div>
        <button class="details-btn" data-index="${index}">Show Details</button>
        <button class="cancel-btn" data-index="${index}">Cancel</button>
      </div>
    `;
    list.appendChild(li);
  });
}

// ‚úÖ Modal popup with clickable map and phone
document.getElementById("bookingList").addEventListener("click", (e) => {
  if (e.target.classList.contains("details-btn")) {
    const worker = getCurrentWorker();
    const idx = parseInt(e.target.dataset.index);
    const key = "bookings_" + worker.email;
    const bookings = JSON.parse(localStorage.getItem(key)) || [];
    const booking = bookings[idx];
    if (!booking) return;

    const userEmail = booking.user;
    const users = JSON.parse(localStorage.getItem("users")) || [];
    const user = users.find(u => u.email === userEmail);

    const locationText = booking.location || "No location provided";
    let mapLink = "";

    if (locationText.startsWith("Lat:")) {
      const coords = locationText.replace("Lat:", "").replace("Lng:", "").split(",");
      if (coords.length === 2) mapLink = `https://www.google.com/maps?q=${coords[0].trim()},${coords[1].trim()}`;
    } else {
      mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationText)}`;
    }

    document.getElementById("modalAddress").textContent = `üìç Address: ${locationText}`;
    document.getElementById("modalPhone").textContent = `üìû Phone: ${user?.phone || "Not provided"}`;
    const mapAnchor = document.querySelector("#modalMap a");
    mapAnchor.href = mapLink;
    mapAnchor.textContent = "View Location";

    document.getElementById("detailsModal").style.display = "flex";
  }
});

function closeModal() {
  document.getElementById("detailsModal").style.display = "none";
}

// Existing cancel booking logic (untouched)
document.getElementById("bookingList").addEventListener("click", (e) => {
  if (e.target.classList.contains("cancel-btn")) {
    const worker = getCurrentWorker();
    const idx = parseInt(e.target.dataset.index);
    const key = "bookings_" + worker.email;
    const bookings = JSON.parse(localStorage.getItem(key)) || [];
    const cancelled = bookings.splice(idx, 1)[0];
    localStorage.setItem(key, JSON.stringify(bookings));

    worker.availability = worker.availability || [];
    worker.availability.push(`${cancelled.date}T${cancelled.time}`);

    const users = JSON.parse(localStorage.getItem("users")) || [];
    users[users.findIndex(u => u.email === worker.email)] = worker;
    localStorage.setItem("users", JSON.stringify(users));

    const notifKey = "notifications_" + cancelled.user;
    const existingNotif = JSON.parse(localStorage.getItem(notifKey)) || [];
    existingNotif.push(`Your booking for ${cancelled.service} on ${cancelled.date} at ${cancelled.time} was cancelled by ${worker.username}.`);
    localStorage.setItem(notifKey, JSON.stringify(existingNotif));

    alert("Booking cancelled and user notified.");
    renderBookings(worker);
    renderAvailability(worker);
  }
});

function renderAvailability(worker) {
  const listDiv = document.getElementById("availabilityList");
  listDiv.innerHTML = "";
  if (!worker.availability || worker.availability.length === 0) {
    listDiv.innerHTML = "<p>No available slots</p>";
    return;
  }
  worker.availability.forEach((slot, index) => {
    const div = document.createElement("div");
    div.className = "availability-slot";
    div.innerHTML = `<span>${slot.replace("T", " ")}</span> 
                     <button class="delete-slot-btn" data-index="${index}">Delete</button>`;
    listDiv.appendChild(div);
  });
}

function loadDashboard() {
  const worker = getCurrentWorker();
  if (!worker) {
    alert("You must login first!");
    window.location.href = "login.html";
    return;
  }

  document.getElementById("workerNameRole").textContent =
    `Welcome, ${worker.username || worker.name} (${worker.service || "Worker"})`;

  renderBookings(worker);
  renderAvailability(worker);

  const notif = JSON.parse(localStorage.getItem("notifications_" + worker.email)) || [];
  document.getElementById("notifBar").textContent =
    notif.length > 0 ? `üîî ${notif[notif.length-1]}` : "No new notifications.";
}

window.onload = loadDashboard;
</script>
</body>
</html>
