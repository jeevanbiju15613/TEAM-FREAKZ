<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book a Worker - NearMe</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .login-btn {
        background-color: #2b5bcf;
        color: white;
        padding: 8px 14px;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background 0.3s;
    }
    .notification-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 15px;
        background: #4CAF50;
        color: white;
        text-align: center;
        z-index: 1000;
        font-weight: bold;
        display:none;
    }
    .container { max-width: 600px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .booking-form { display: flex; flex-direction: column; gap: 15px; }
    .booking-form input, .booking-form select, .book-btn, .back-btn { padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    .book-btn { background: #2b5bcf; color: white; border: none; cursor: pointer; }
    .book-btn:hover { background: #1d3e91; }
    .back-btn { text-align: center; display: block; margin-top: 20px; text-decoration: none; color: #333; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: rgba(255,255,255,0.85); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="booking-page">

<header>
  <div class="logo-title">
      <img src="Ellipse 4.png" alt="Worker Logo">
      <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
  </div>
  <div class="nav-right">
    <button class="login-btn" id="authBtn" onclick="window.location.href='login.html'">Login</button>
  </div>
</header>

<div class="notification-bar">
  âœ… Your booking with <b id="workerName"></b> is confirmed!
</div>

<div class="container">
  <h2>ðŸ”§ Book a Worker</h2>
  <form class="booking-form" id="bookingForm">

    <!-- Service Selection -->
    <label for="service">Select Service</label>
    <select id="service" name="service">
      <option value="">--Choose Service--</option>
      <option value="Electrician">Electrician</option>
      <option value="Plumber">Plumber</option>
      <option value="Cleaner">Cleaner</option>
      <option value="Coolie">Coolie</option>
      <option value="Mechanic">Mechanic</option>
    </select>

    <!-- Date Selection -->
    <label for="date">Select Date</label>
    <input type="date" id="date" name="date">

    <!-- Worker Selection -->
    <label for="worker">Choose Worker</label>
    <select id="worker" name="worker">
      <option disabled>Select a service and date first</option>
    </select>

    <!-- Manual Time -->
    <label for="time">Select Time</label>
    <input type="time" id="time" name="time" min="07:00" max="21:00">

    <!-- Available Slots -->
    <label for="availableSlots">Available Slots</label>
    <select id="availableSlots">
      <option disabled selected>Select a worker to view available slots</option>
    </select>

    <button type="submit" class="book-btn">Confirm Booking</button>

    <p id="confirmation" style="display:none; color:green; margin-top:15px; font-weight:bold;">
      âœ… Booking Confirmed! Redirecting to services...
    </p>
    <a href="ar.html" class="back-btn">â¬… Back to Services</a>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const workerSelect = document.getElementById('worker');
  const dateInput = document.getElementById('date');
  const slotSelect = document.getElementById('availableSlots');
  const serviceSelect = document.getElementById('service');
  const confirmBtn = document.getElementById('confirmBooking');

  // Generate time slots (7 AM to 9 PM)
  function generateTimeSlots() {
    const times = [];
    for (let hour = 7; hour <= 21; hour++) {
      const ampm = hour < 12 ? "AM" : "PM";
      const displayHour = hour % 12 === 0 ? 12 : hour % 12;
      times.push(`${displayHour.toString().padStart(2, '0')}:00 ${ampm}`);
    }
    return times;
  }

  // Update available slots when worker/date changes
  function updateAvailableSlots() {
    const workerEmail = workerSelect.value;
    const selectedDate = dateInput.value;
    slotSelect.innerHTML = '';

    if (!workerEmail || !selectedDate) {
      slotSelect.innerHTML = '<option value="">Select worker and date first</option>';
      return;
    }

    const allSlots = generateTimeSlots();
    const workerBookings = JSON.parse(localStorage.getItem(`bookings_${workerEmail}`)) || [];

    // Get times already booked on this date
    const bookedTimes = workerBookings
      .filter(b => b.date === selectedDate)
      .map(b => b.time);

    // Only show available times
    const availableTimes = allSlots.filter(t => !bookedTimes.includes(t));

    if (availableTimes.length === 0) {
      slotSelect.innerHTML = '<option value="">No available slots for this date</option>';
      confirmBtn.disabled = true;
    } else {
      confirmBtn.disabled = false;
      slotSelect.innerHTML = '<option value="">Select a time slot</option>';
      availableTimes.forEach(time => {
        const opt = document.createElement('option');
        opt.value = time;
        opt.textContent = time;
        slotSelect.appendChild(opt);
      });
    }
  }

  // Handle booking confirmation
  confirmBtn.addEventListener('click', () => {
    const workerEmail = workerSelect.value;
    const selectedDate = dateInput.value;
    const selectedTime = slotSelect.value;
    const service = serviceSelect.value;

    if (!service || !workerEmail || !selectedDate || !selectedTime) {
      alert("Please fill all details before confirming.");
      return;
    }

    const key = `bookings_${workerEmail}`;
    const existingBookings = JSON.parse(localStorage.getItem(key)) || [];

    // Double-check slot availability
    const alreadyBooked = existingBookings.some(b => b.date === selectedDate && b.time === selectedTime);
    if (alreadyBooked) {
      alert("That time slot is already booked. Please choose another one.");
      updateAvailableSlots();
      return;
    }

    // Add new booking
    existingBookings.push({
      service,
      date: selectedDate,
      time: selectedTime,
      status: "booked"
    });

    localStorage.setItem(key, JSON.stringify(existingBookings));

    alert("âœ… Booking confirmed successfully!");
    updateAvailableSlots(); // Refresh available slots
  });

  workerSelect.addEventListener('change', updateAvailableSlots);
  dateInput.addEventListener('change', updateAvailableSlots);
</script>

</body>
</html>