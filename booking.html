<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book a Worker - NearMe</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .login-btn {
        background-color: #2b5bcf;
        color: white;
        padding: 8px 14px;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background 0.3s;
    }
    .notification-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 15px;
        background: #4CAF50;
        color: white;
        text-align: center;
        z-index: 1000;
        font-weight: bold;
        display:none;
    }
    .container { max-width: 600px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .booking-form { display: flex; flex-direction: column; gap: 15px; }
    .booking-form input, .booking-form select, .book-btn, .back-btn { padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    .book-btn { background: #2b5bcf; color: white; border: none; cursor: pointer; }
    .book-btn:hover { background: #1d3e91; }
    .back-btn { text-align: center; display: block; margin-top: 20px; text-decoration: none; color: #333; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: rgba(255,255,255,0.85); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="booking-page">

<header>
  <div class="logo-title">
      <img src="Ellipse 4.png" alt="Worker Logo">
      <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
  </div>
  <div class="nav-right">
    <button class="login-btn" id="authBtn" onclick="window.location.href='login.html'">Login</button>
  </div>
</header>

<div class="notification-bar">
  ‚úÖ Your booking with <b id="workerName"></b> is confirmed!
</div>

<div class="container">
  <h2>üîß Book a Worker</h2>
  <form class="booking-form" id="bookingForm">

    <!-- Service Selection -->
    <label for="service">Select Service</label>
    <select id="service" name="service">
      <option value="">--Choose Service--</option>
      <option value="Electrician">Electrician</option>
      <option value="Plumber">Plumber</option>
      <option value="Cleaner">Cleaner</option>
      <option value="Coolie">Coolie</option>
      <option value="Mechanic">Mechanic</option>
    </select>

    <!-- Date Selection moved before Worker -->
    <label for="date">Select Date</label>
    <input type="date" id="date" name="date">

    <!-- Worker Selection -->
    <label for="worker">Choose Worker</label>
    <select id="worker" name="worker">
      <option disabled>Select a service and date first</option>
    </select>

    <label for="time">Select Time</label>
    <input type="time" id="time" name="time" min="07:00" max="21:00">

    <button type="submit" class="book-btn">Confirm Booking</button>

    <p id="confirmation" style="display:none; color:green; margin-top:15px; font-weight:bold;">
      ‚úÖ Booking Confirmed! Redirecting to services...
    </p>
    <a href="ar.html" class="back-btn">‚¨Ö Back to Services</a>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {
    const LOGGED_IN = localStorage.getItem("loggedIn") === "true";
    const username = localStorage.getItem("username") || "Myprofile";

    // --- Update Header ---
    if (LOGGED_IN) {
        $("#authBtn").text(username).css("background-color", "#4CAF50").off("click").on("click", function() {
            window.location.href='user-dashboard.html';
        });
    }

    if (!LOGGED_IN) {
        alert("üîí Please log in to view and confirm your booking.");
        window.location.replace("login.html?redirect=" + encodeURIComponent(window.location.href));
        return;
    }

    // Date restrictions
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    $("#date").attr("min", `${yyyy}-${mm}-${dd}`).attr("max", `${yyyy}-12-31`);

    // --- Restore pending service if any ---
    const pendingService = localStorage.getItem("pendingService");
    if (pendingService) {
        $("#service").val(pendingService);
        localStorage.removeItem("pendingService");
    }

    // Load available workers for selected service & date
    function loadAvailableWorkers() {
        const selectedDate = $("#date").val();
        const selectedService = $("#service").val();
        const $workerSelect = $("#worker");
        $workerSelect.empty();

        if (!selectedDate || !selectedService) {
            $workerSelect.append('<option disabled>Select a service and date first</option>');
            return;
        }

        const users = JSON.parse(localStorage.getItem("users")) || [];
        const availableWorkers = users.filter(u => 
            u.role === "worker" &&
            u.availability &&
            u.availability.some(slot => slot.startsWith(selectedDate)) &&
            u.categories && u.categories.includes(selectedService)
        );

        if (availableWorkers.length === 0) {
            $workerSelect.append('<option disabled>No workers available for this service on this date</option>');
            return;
        }

        availableWorkers.forEach(worker => {
            const categories = worker.categories ? worker.categories.join(", ") : "";
            $workerSelect.append(`<option value="${worker.email}">${worker.name} (${categories})</option>`);
        });
    }

    $("#service, #date").on("change", loadAvailableWorkers);

    // If service was preloaded, auto-trigger loading after service is set
    if ($("#service").val()) {
        loadAvailableWorkers();
    }

    // Handle booking submission
    $("#bookingForm").on("submit", function(e) {
        e.preventDefault();
        const workerEmail = $("#worker").val();
        const serviceType = $("#service").val();
        const date = $("#date").val();
        const time = $("#time").val();

        if (!workerEmail || !date || !time || !serviceType) {
            alert("‚ö†Ô∏è Please fill all fields.");
            return;
        }

        if (time < "07:00" || time > "21:00") {
            alert("‚è∞ Please select a time between 7:00 AM and 9:00 PM.");
            $("#time").val("");
            return;
        }

        const users = JSON.parse(localStorage.getItem("users")) || [];
        const workerObj = users.find(u => u.email === workerEmail);

        const selectedSlot = date + "T" + time;
        if (!workerObj.availability.includes(selectedSlot)) {
            alert("‚ö†Ô∏è Selected slot is no longer available.");
            return;
        }

        // Remove booked slot
        workerObj.availability = workerObj.availability.filter(s => s !== selectedSlot);

        // --- Save booking for worker dashboard ---
        const workerBookingsKey = "bookings_" + workerObj.email;
        const workerBookings = JSON.parse(localStorage.getItem(workerBookingsKey)) || [];
        workerBookings.unshift({
            user: localStorage.getItem("username"),
            service: serviceType,
            date: date,
            time: time,
            status: "confirmed",
            timestamp: new Date().toISOString()
        });
        localStorage.setItem(workerBookingsKey, JSON.stringify(workerBookings));

        // Update worker in users array
        users[users.findIndex(u => u.email === workerEmail)] = workerObj;
        localStorage.setItem("users", JSON.stringify(users));

        // Save booking for user history
        const historyKey = `userBookingHistory_${username}`;
        const history = JSON.parse(localStorage.getItem(historyKey)) || [];
        history.unshift({ worker: workerObj.name, service: serviceType, date, time, status: "confirmed", timestamp: new Date().toISOString() });
        localStorage.setItem(historyKey, JSON.stringify(history));

        // Show notification
        $("#workerName").text(workerObj.name);
        $(".notification-bar").fadeIn();
        $("#confirmation").fadeIn();
        $(".book-btn").text("Booking Confirmed!").css("background-color", "#4CAF50").prop("disabled", true);

        setTimeout(() => window.location.href = "ar.html?booking=success", 2000);
    });
});
</script>

</body>
</html>
