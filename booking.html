<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book a Worker - NearMe</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="booking-page">

  <!-- Header -->
  <header>
    <div class="logo">NEARME</div>
    <div class="nav-right">
      <button class="login-btn" onclick="window.location.href='login.html'">Login</button>
    </div>
  </header>

  <!-- Notification Bar (hidden by default) -->
  <div class="notification-bar" style="display:none;">
    ‚úÖ Your booking with <b id="workerName"></b> is confirmed!
  </div>

  <!-- Booking Form -->
  <div class="container">
    <h2>üîß Book a Worker</h2>
    <form class="booking-form" id="bookingForm">
      <label for="worker">Choose Worker</label>
      <select id="worker" name="worker">
        <option>Electrician Rahul</option>
        <option>Plumber Suresh</option>
        <option>Cleaner Anita</option>
        <option>Coolie Anita</option>
        <option>Mechanic Anita</option>

      </select>

      <label for="date">Select Date</label>
      <input type="date" id="date" name="date">

      <label for="time">Select Time</label>
      <!-- ‚è∞ Restrict to 07:00 - 21:00 -->
      <input type="time" id="time" name="time" min="07:00" max="21:00">

      <button type="submit" class="book-btn">Confirm Booking</button>

      <p id="confirmation" style="display:none; color:green; margin-top:15px; font-weight:bold;">
        ‚úÖ Booking Confirmed! You can check notifications for updates.
      </p>
      <a href="ar.html" class="back-btn">‚¨Ö Back to Services</a>
    </form>
  </div>

<script>
  (function () {
    const form = document.getElementById("bookingForm");
    const workerSelect = document.getElementById("worker");
    const dateInput = document.getElementById("date");
    const timeInput = document.getElementById("time");
    const workerName = document.getElementById("workerName");
    const notificationBar = document.querySelector(".notification-bar");
    const confirmation = document.getElementById("confirmation");

    const urlParams = new URLSearchParams(window.location.search);
    let serviceTypeFromUrl = urlParams.get("service");

    function ensureOptionExists(selectEl, text) {
      for (let i = 0; i < selectEl.options.length; i++) {
        if (selectEl.options[i].text === text) return;
      }
      const opt = document.createElement("option");
      opt.text = text;
      selectEl.add(opt, 0);
    }

    // üîπ Restore pending booking (if exists)
    let pendingBooking = null;
    try {
      pendingBooking = JSON.parse(localStorage.getItem("pendingBooking"));
    } catch (e) { pendingBooking = null; }

    const effectiveServiceType = serviceTypeFromUrl || (pendingBooking && pendingBooking.serviceType) || null;

    if (effectiveServiceType) {
      const lower = effectiveServiceType.toLowerCase();
      const opts = Array.from(workerSelect.options);
      workerSelect.innerHTML = "";
      opts.forEach(o => {
        if (o.text.toLowerCase().includes(lower)) {
          workerSelect.add(o);
        }
      });
      if (workerSelect.options.length === 0 && pendingBooking && pendingBooking.worker) {
        ensureOptionExists(workerSelect, pendingBooking.worker);
      }
    }

    if (pendingBooking) {
      if (pendingBooking.worker) {
        ensureOptionExists(workerSelect, pendingBooking.worker);
        workerSelect.value = pendingBooking.worker;
      }
      if (pendingBooking.date) dateInput.value = pendingBooking.date;
      if (pendingBooking.time) timeInput.value = pendingBooking.time;
    }

    // üîπ Handle booking form submit
    form.addEventListener("submit", function (ev) {
      ev.preventDefault();

      const chosenWorker = workerSelect.value;
      const chosenDate = dateInput.value;
      const chosenTime = timeInput.value;

      if (!chosenWorker || !chosenDate || !chosenTime) {
        alert("Please fill all fields.");
        return;
      }

      // ‚è∞ Time validation (07:00 - 21:00)
      if (chosenTime < "07:00" || chosenTime > "21:00") {
        alert("‚è∞ Please select a time between 7:00 AM and 9:00 PM.");
        timeInput.value = ""; // reset invalid time
        return;
      }

      const loggedIn = localStorage.getItem("loggedIn") === "true";

      if (!loggedIn) {
        // save booking and redirect to login
        const bookingData = { worker: chosenWorker, date: chosenDate, time: chosenTime, serviceType: effectiveServiceType };
        localStorage.setItem("pendingBooking", JSON.stringify(bookingData));

        // include redirect param
        const loginUrl = "login.html?redirect=" + encodeURIComponent("booking.html");
        window.location.href = loginUrl;
        return;
      }

      // ‚úÖ Already logged in ‚Üí confirm booking
      workerName.textContent = chosenWorker;
      notificationBar.style.display = "block";
      confirmation.style.display = "block";

      localStorage.removeItem("pendingBooking");
    });
  })();
</script>

</body>
</html>
