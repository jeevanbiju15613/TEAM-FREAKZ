<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Book a Worker - NearMe</title>
Â  <link rel="stylesheet" href="style.css" />
</head>
<body class="booking-page">

Â  Â  <header>
Â  Â <div class="logo-title">
Â  Â  Â  Â  <img src="Ellipse 4.png" alt="Worker Logo">
Â  Â  Â  Â  <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
Â  Â  </div>
Â  Â  <div class="nav-right">
Â  Â  Â  <button class="login-btn" id="authBtn" onclick="window.location.href='login.html'">Login</button>
Â  Â  </div>
Â  </header>

Â  Â  <div class="notification-bar" style="display:none;">
Â  Â  âœ… Your booking with <b id="workerName"></b> is confirmed!
Â  </div>

Â  Â  <div class="container">
Â  Â  <h2>ğŸ”§ Book a Worker</h2>
Â  Â  <form class="booking-form" id="bookingForm">
Â  Â  Â  <label for="worker">Choose Worker</label>
Â  Â  Â  <select id="worker" name="worker">
Â  Â  Â  Â  <option>Electrician Rahul</option>
Â  Â  Â  Â  <option>Plumber Suresh</option>
Â  Â  Â  Â  <option>Cleaner Anita</option>
Â  Â  Â  Â  <option>Coolie Dev</option>
Â  Â  Â  Â  <option>Mechanic Javed</option>
Â  Â  Â  </select>

Â  Â  Â  <label for="date">Select Date</label>
Â  Â  Â  <input type="date" id="date" name="date">

Â  Â  Â  <label for="time">Select Time</label>
Â  Â  Â  <input type="time" id="time" name="time" min="07:00" max="21:00">

Â  Â  Â  <button type="submit" class="book-btn">Confirm Booking</button>

Â  Â  Â  <p id="confirmation" style="display:none; color:green; margin-top:15px; font-weight:bold;">
Â  Â  Â  Â  âœ… Booking Confirmed! Redirecting to services...
Â  Â  Â  </p>
Â  Â  Â  <a href="ar.html" class="back-btn">â¬… Back to Services</a>
Â  Â  </form>
Â  </div>

Â  Â  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

Â  <script>
Â  Â  $(document).ready(function () {
Â  Â  Â  // --- Setup and Header Update ---
      const LOGGED_IN = localStorage.getItem("loggedIn") === "true";
      const username = localStorage.getItem("username") || "Myprofile";
      const urlParams = new URLSearchParams(window.location.search);
      let serviceType = urlParams.get("service");

      // Update Header Button based on login status
      if (LOGGED_IN) {
          $("#authBtn").text(username).css("background-color", "#4CAF50").off("click").on("click", function() {
              window.location.href='user-dashboard.html';
          });
      } else {
          $("#authBtn").text("Login").css("background-color", "#2b5bcf").off("click").on("click", function() {
              window.location.href='login.html';
          });
      }

Â  Â  Â  // â³ Date restrictions (Keep original logic)
Â  Â  Â  const today = new Date();
Â  Â  Â  const yyyy = today.getFullYear();
Â  Â  Â  const mm = String(today.getMonth() + 1).padStart(2, "0");
Â  Â  Â  const dd = String(today.getDate()).padStart(2, "0");
Â  Â  Â  const todayStr = `${yyyy}-${mm}-${dd}`;
Â  Â  Â  $("#date").attr("min", todayStr).attr("max", `${yyyy}-12-31`);

Â  Â  Â  // ğŸ”¹ Filter workers based on service type from URL (Keep original logic)
Â  Â  Â  if (serviceType) {
Â  Â  Â  Â  const typeLower = serviceType.toLowerCase();
Â  Â  Â  Â  $("#worker option").each(function () {
Â  Â  Â  Â  Â  if (!$(this).text().toLowerCase().includes(typeLower)) {
Â  Â  Â  Â  Â  Â  $(this).remove();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // ğŸš€ RESTORE AND AUTO-CONFIRM LOGIC
Â  Â  Â  let pendingBooking = null;
Â  Â  Â  try { pendingBooking = JSON.parse(localStorage.getItem("pendingBooking")); } catch (e) {}

Â  Â  Â  // **Core change:** Only auto-confirm if user returned from login with the 'continue' flag
Â  Â  Â  if (pendingBooking && LOGGED_IN && urlParams.get("continue") === "booking") {
          // Pre-fill and auto-confirm
          $("#worker").val(pendingBooking.worker);
          $("#date").val(pendingBooking.date);
          $("#time").val(pendingBooking.time);
Â  Â  Â  Â    autoConfirmBooking(pendingBooking);
Â  Â  Â  Â    return; 
Â  Â  Â  }

Â  Â  Â  // ğŸ”¹ Form submission (Core Logic)
Â  Â  Â  $("#bookingForm").on("submit", function (e) {
Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  const worker = $("#worker").val();
Â  Â  Â  Â  const date = $("#date").val();
Â  Â  Â  Â  const time = $("#time").val();

Â  Â  Â  Â  if (!worker || !date || !time) {
Â  Â  Â  Â  Â  alert("âš ï¸ Please fill all fields.");
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (time < "07:00" || time > "21:00") {
Â  Â  Â  Â  Â  alert("â° Please select a time between 7:00 AM and 9:00 PM.");
Â  Â  Â  Â  Â  $("#time").val("");
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

        const bookingData = { worker, date, time, serviceType: serviceType || 'General' };

Â  Â  Â  Â  if (!LOGGED_IN) {
Â  Â  Â  Â  Â  // **Path 1: NOT LOGGED IN (Coming from 1.html or similar) -> Redirect to login**
Â  Â  Â  Â  Â  localStorage.setItem("pendingBooking", JSON.stringify(bookingData));
          alert("ğŸ”’ Please log in to confirm your booking. Redirecting now...");
Â  Â  Â  Â  Â  window.location.href = "login.html?redirect=booking.html";
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // **Path 2: ALREADY LOGGED IN (Coming from ar.html) -> Confirm immediately**
Â  Â  Â  Â  autoConfirmBooking(bookingData);
Â  Â  Â  });

Â  Â  Â  // ğŸ”¹ Function to confirm booking (with AJAX simulation)
Â  Â  Â  function autoConfirmBooking(data) {
          const $button = $(".book-btn");
Â  Â  Â  Â  $.ajax({
Â  Â  Â  Â  Â  url: "dummyBookingAPI", // Placeholder
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  data: data,
          timeout: 100, 
Â  Â  Â  Â  Â  beforeSend: function () {
Â  Â  Â  Â  Â  Â  $button.text("â³ Processing...").prop("disabled", true);
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  complete: function () {
Â  Â  Â  Â  Â  Â  // Confirmation UI Update
Â  Â  Â  Â  Â  Â  $("#workerName").text(data.worker);
Â  Â  Â  Â  Â  Â  $(".notification-bar").fadeIn();
Â  Â  Â  Â  Â  Â  $("#confirmation").fadeIn();
Â  Â  Â  Â  Â  Â  localStorage.removeItem("pendingBooking");

             $button.text("Booking Confirmed!").css("background-color", "#4CAF50").prop("disabled", true);
             
             // **CRITICAL: Save booking to history in localStorage**
             saveBookingToHistory(data);

Â  Â  Â  Â  Â  Â  // â© Redirect to services page with success flag
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  window.location.href = "ar.html?booking=success";
Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
      
      // Function to save booking data to localStorage history
      function saveBookingToHistory(booking) {
          const historyKey = 'userBookingHistory';
          let history = [];
          try {
              history = JSON.parse(localStorage.getItem(historyKey)) || [];
          } catch (e) {
              console.error("Error parsing booking history:", e);
          }
          
          const newBooking = {
              worker: booking.worker,
              service: booking.serviceType,
              date: booking.date,
              time: booking.time,
              status: "confirmed",
              timestamp: new Date().toISOString()
          };
          
          history.unshift(newBooking); // Add to the start
          localStorage.setItem(historyKey, JSON.stringify(history));
      }
Â  Â  });
Â  </script>

</body>
</html>