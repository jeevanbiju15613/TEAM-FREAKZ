<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Service - NearMe</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f9f9f9; }
    header { background:#4a7fe3; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:10px 20px; }
    .nav-right { display:flex; gap:15px; align-items:center; }
    .logout-btn { background:#e63946; border:none; border-radius:6px; padding:6px 14px; color:#fff; cursor:pointer; }
    .logout-btn:hover { background:#c92a36; }
    .container { max-width:900px; margin:40px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h2 { text-align:center; color:#333; }
    label { display:block; margin-top:15px; margin-bottom:5px; font-weight:bold; }
    select, input[type="date"], input[type="time"], input[type="text"] { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    button { background:#4a7fe3; color:#fff; border:none; border-radius:6px; padding:10px 16px; margin-top:20px; cursor:pointer; }
    button:hover { background:#365dcf; }

    /* Notification bar */
    #notifyBar {
      display:none;
      position:fixed;
      top:0;
      left:50%;
      transform:translateX(-50%) translateY(-100%);
      background:#2b5bcf;
      color:white;
      padding:12px 20px;
      border-radius:0 0 8px 8px;
      font-weight:500;
      transition:transform 0.4s ease;
      z-index:1000;
    }

    .location-row { display:flex; gap:10px; align-items:center; }
    .location-row button { padding:8px 12px; margin-top:0; white-space:nowrap; }
  </style>
</head>
<body>

  <header>
    <div class="logo-title">
      <img src="Ellipse 4.png" alt="Logo" width="60">
      <div class="logo"><span style="color:red;">N</span>EAR<span style="color:red;">M</span>E</div>
    </div>
    <div class="nav-right">
      <a href="ar.html">üè† Home</a>
      <a href="user-dashboard.html">üë§ My Profile</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="container">
    <h2>Book Your Service</h2>

    <label for="service">Service</label>
    <select id="service">
      <option value="">Select Service</option>
      <option value="Electrician">Electrician</option>
      <option value="Plumber">Plumber</option>
      <option value="Carpenter">Carpenter</option>
      <option value="Mechanic">Mechanic</option>
    </select>

    <label for="date">Select Date</label>
    <input type="date" id="date">

    <label for="worker">Available Workers</label>
    <select id="worker">
      <option value="">Select service and date first</option>
    </select>

    <label for="time">Available Slots</label>
    <select id="time">
      <option value="">Select worker to view slots</option>
    </select>

    <label for="location">Your Location</label>
    <div class="location-row">
      <input type="text" id="location" placeholder="Enter your address or location">
      <button type="button" onclick="getLocation()">üìç Use My Location</button>
    </div>

    <button id="bookBtn">Confirm Booking</button>
  </div>

  <div id="notifyBar"></div>

  <script>
    function logout() {
      localStorage.removeItem("loggedIn");
      localStorage.removeItem("loggedInUser");
      localStorage.removeItem("username");
      localStorage.removeItem("role");
      window.location.href = "login.html";
    }

    const serviceSelect = document.getElementById("service");
    const dateInput = document.getElementById("date");
    const workerSelect = document.getElementById("worker");
    const timeSelect = document.getElementById("time");
    const locationInput = document.getElementById("location");
    const notifyBar = document.getElementById("notifyBar");

    // ‚úÖ Set date range: today ‚Üí end of current year
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    const minDate = `${yyyy}-${mm}-${dd}`;
    const maxDate = `${yyyy}-12-31`;
    dateInput.min = minDate;
    dateInput.max = maxDate;

    // üì¢ Notification
    function showNotification(message, success = true) {
      notifyBar.textContent = message;
      notifyBar.style.background = success ? "#2b5bcf" : "#e74c3c";
      notifyBar.style.display = "block";
      setTimeout(() => (notifyBar.style.transform = "translateX(-50%) translateY(0)"), 10);
      setTimeout(() => {
        notifyBar.style.transform = "translateX(-50%) translateY(-100%)";
        setTimeout(() => (notifyBar.style.display = "none"), 400);
      }, 2500);
    }

    // üìç Get user's location
    function getLocation() {
      if (!navigator.geolocation) {
        showNotification("Geolocation not supported by your browser", false);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          locationInput.value = `Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`;
          showNotification("üìç Location captured successfully!");
        },
        () => showNotification("Unable to fetch your location", false)
      );
    }

    function getAllWorkers() {
      const users = JSON.parse(localStorage.getItem("users")) || [];
      return users.filter(u => u.role === "worker");
    }

    function updateWorkerList() {
      workerSelect.innerHTML = '<option value="">Select service and date first</option>';
      const selectedDate = dateInput.value;
      const selectedService = serviceSelect.value;
      if (!selectedDate || !selectedService) return;

      const allWorkers = getAllWorkers();
      const availableWorkers = allWorkers.filter(w =>
        (w.service === selectedService || (w.categories && w.categories.includes(selectedService))) &&
        w.availability &&
        w.availability.some(slot => slot.startsWith(selectedDate))
      );

      if (availableWorkers.length === 0) {
        workerSelect.innerHTML = '<option>No workers available on this date</option>';
      } else {
        workerSelect.innerHTML = '<option value="">Select a worker</option>';
        availableWorkers.forEach(w => {
          const opt = document.createElement("option");
          opt.value = w.email;
          opt.textContent = `${w.username || w.name} (${selectedService})`;
          workerSelect.appendChild(opt);
        });
      }
    }

    function updateAvailableSlots() {
      timeSelect.innerHTML = '<option value="">Select worker to view slots</option>';
      const workerEmail = workerSelect.value;
      const selectedDate = dateInput.value;
      if (!workerEmail || !selectedDate) return;

      const workers = getAllWorkers();
      const worker = workers.find(w => w.email === workerEmail);
      if (!worker) return;

      const available = (worker.availability || [])
        .filter(slot => slot.startsWith(selectedDate))
        .map(slot => slot.split("T")[1]);

      const bookings = JSON.parse(localStorage.getItem(`bookings_${workerEmail}`)) || [];
      const bookedTimes = bookings.filter(b => b.date === selectedDate).map(b => b.time);

      const freeSlots = available.filter(t => !bookedTimes.includes(t));
      if (freeSlots.length === 0) {
        timeSelect.innerHTML = '<option>No free slots left</option>';
      } else {
        timeSelect.innerHTML = '<option value="">Select time slot</option>';
        freeSlots.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          timeSelect.appendChild(opt);
        });
      }
    }

    document.getElementById("bookBtn").addEventListener("click", () => {
      const service = serviceSelect.value;
      const date = dateInput.value;
      const workerEmail = workerSelect.value;
      const time = timeSelect.value;
      const location = locationInput.value.trim();

      if (!service || !date || !workerEmail || !time || !location) {
        showNotification("‚ö†Ô∏è Please fill all fields.", false);
        return;
      }

      const key = `bookings_${workerEmail}`;
      const existing = JSON.parse(localStorage.getItem(key)) || [];

      if (existing.some(b => b.date === date && b.time === time)) {
        showNotification("‚ùå That slot is already booked!", false);
        return;
      }

      const newBooking = {
        service,
        date,
        time,
        user: localStorage.getItem("username") || "User",
        location
      };
      existing.push(newBooking);
      localStorage.setItem(key, JSON.stringify(existing));

      showNotification("‚úÖ Booking Confirmed!");
      updateAvailableSlots();
    });

    dateInput.addEventListener("change", updateWorkerList);
    serviceSelect.addEventListener("change", updateWorkerList);
    workerSelect.addEventListener("change", updateAvailableSlots);
  </script>

</body>
</html>
