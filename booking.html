<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Book a Worker - NearMe</title>
Â  <link rel="stylesheet" href="style.css" />
Â  <style>
    /* Styling to ensure the login/profile button is correctly sized */
    .login-btn, .Myprofile-btn {
        background-color: #2b5bcf;
        color: white;
        padding: 8px 14px;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background 0.3s;
    }
    .notification-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 15px;
        background: #4CAF50;
        color: white;
        text-align: center;
        z-index: 1000;
        font-weight: bold;
    }
    /* Simple form and container styles */
    .container { max-width: 600px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .booking-form { display: flex; flex-direction: column; gap: 15px; }
    .booking-form input, .booking-form select, .book-btn, .back-btn { padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    .book-btn { background: #2b5bcf; color: white; border: none; cursor: pointer; }
    .book-btn:hover { background: #1d3e91; }
    .back-btn { text-align: center; display: block; margin-top: 20px; text-decoration: none; color: #333; }
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body class="booking-page">

Â  Â  <header>
Â  Â <div class="logo-title">
Â  Â  Â  Â  <img src="Ellipse 4.png" alt="Worker Logo">
Â  Â  Â  Â  <div class="logo"><span style="color: red;">N</span>EAR<span style="color: red;">M</span>E</div>
Â  Â  </div>
Â  Â  <div class="nav-right">
Â  Â  Â  <button class="login-btn" id="authBtn" onclick="window.location.href='login.html'">Login</button>
Â  Â  </div>
Â  </header>

Â  Â  <div class="notification-bar" style="display:none;">
Â  Â  âœ… Your booking with <b id="workerName"></b> is confirmed!
Â  </div>

Â  Â  <div class="container">
Â  Â  <h2>ğŸ”§ Book a Worker</h2>
Â  Â  <form class="booking-form" id="bookingForm">
Â  Â  Â  <label for="worker">Choose Worker</label>
Â  Â  Â  <select id="worker" name="worker">
Â  Â  Â  Â  <option>Electrician Rahul</option>
Â  Â  Â  Â  <option>Plumber Suresh</option>
Â  Â  Â  Â  <option>Cleaner Anita</option>
Â  Â  Â  Â  <option>Coolie Dev</option>
Â  Â  Â  Â  <option>Mechanic Javed</option>
Â  Â  Â  </select>

Â  Â  Â  <label for="date">Select Date</label>
Â  Â  Â  <input type="date" id="date" name="date">

Â  Â  Â  <label for="time">Select Time</label>
Â  Â  Â  <input type="time" id="time" name="time" min="07:00" max="21:00">

Â  Â  Â  <button type="submit" class="book-btn">Confirm Booking</button>

Â  Â  Â  <p id="confirmation" style="display:none; color:green; margin-top:15px; font-weight:bold;">
Â  Â  Â  Â  âœ… Booking Confirmed! Redirecting to services...
Â  Â  Â  </p>
Â  Â  Â  <a href="ar.html" class="back-btn">â¬… Back to Services</a>
Â  Â  </form>
Â  </div>

Â  Â  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

Â  <script>
Â  Â  $(document).ready(function () {
Â  Â  Â  // --- Setup and Header Update ---
Â  Â  Â  const LOGGED_IN = localStorage.getItem("loggedIn") === "true";
Â  Â  Â  const username = localStorage.getItem("username") || "Myprofile";
Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  let serviceType = urlParams.get("service");
Â  Â  Â  let pendingBooking = null;
Â  Â  Â  try { pendingBooking = JSON.parse(localStorage.getItem("pendingBooking")); } catch (e) {}

Â  Â  Â  // Update Header Button based on login status
Â  Â  Â  if (LOGGED_IN) {
Â  Â  Â  Â  Â  $("#authBtn").text(username).css("background-color", "#4CAF50").off("click").on("click", function() {
Â  Â  Â  Â  Â  Â  Â  window.location.href='user-dashboard.html';
Â  Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  Â  $("#authBtn").text("Login").css("background-color", "#2b5bcf").off("click").on("click", function() {
Â  Â  Â  Â  Â  Â  Â  window.location.href='login.html';
Â  Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // â³ Date restrictions 
Â  Â  Â  const today = new Date();
Â  Â  Â  const yyyy = today.getFullYear();
Â  Â  Â  const mm = String(today.getMonth() + 1).padStart(2, "0");
Â  Â  Â  const dd = String(today.getDate()).padStart(2, "0");
Â  Â  Â  const todayStr = `${yyyy}-${mm}-${dd}`;
Â  Â  Â  $("#date").attr("min", todayStr).attr("max", `${yyyy}-12-31`);

Â  Â  Â  // ğŸ”¹ Filter workers based on service type from URL
Â  Â  Â  if (serviceType) {
Â  Â  Â  Â  const typeLower = serviceType.toLowerCase();
Â  Â  Â  Â  $("#worker option").each(function () {
Â  Â  Â  Â  Â  if (!$(this).text().toLowerCase().includes(typeLower)) {
Â  Â  Â  Â  Â  Â  $(this).remove();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  
Â  Â  Â  // ğŸ›‘ CORE CHANGE: Strict Login Enforcement
Â  Â  Â  // If the user is NOT logged in AND they are not returning from a successful login
Â  Â  Â  if (!LOGGED_IN && urlParams.get("continue") !== "booking") {
Â  Â  Â  Â  Â  // Redirect to login.html, saving the destination URL
          // The 'service' param ensures the worker list is filtered correctly after login.
Â  Â  Â  Â  Â  const redirectUrl = "booking.html?continue=booking" + (serviceType ? "&service=" + encodeURIComponent(serviceType) : '');
Â  Â  Â  Â  Â  alert("ğŸ”’ Please log in to view and confirm your booking.");
Â  Â  Â  Â  Â  window.location.replace("login.html?redirect=" + encodeURIComponent(redirectUrl));
Â  Â  Â  Â  Â  return; // Stop execution here
Â  Â  Â  }

Â  Â  Â  // ğŸš€ RESTORE AND AUTO-CONFIRM LOGIC
Â  Â  Â  // This runs if the user just logged in and was redirected here with a pending booking.
Â  Â  Â  if (pendingBooking && LOGGED_IN && urlParams.get("continue") === "booking") {
Â  Â  Â  Â  Â  // Pre-fill and auto-confirm
Â  Â  Â  Â  Â  $("#worker").val(pendingBooking.worker);
Â  Â  Â  Â  Â  $("#date").val(pendingBooking.date);
Â  Â  Â  Â  Â  $("#time").val(pendingBooking.time);
Â  Â  Â  Â  Â  autoConfirmBooking(pendingBooking);
Â  Â  Â  Â  Â  return; 
Â  Â  Â  }


Â  Â  Â  // ğŸ”¹ Form submission (Core Logic)
Â  Â  Â  $("#bookingForm").on("submit", function (e) {
Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  const worker = $("#worker").val();
Â  Â  Â  Â  const date = $("#date").val();
Â  Â  Â  Â  const time = $("#time").val();

Â  Â  Â  Â  if (!worker || !date || !time) {
Â  Â  Â  Â  Â  alert("âš ï¸ Please fill all fields.");
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (time < "07:00" || time > "21:00") {
Â  Â  Â  Â  Â  alert("â° Please select a time between 7:00 AM and 9:00 PM.");
Â  Â  Â  Â  Â  $("#time").val("");
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const bookingData = { worker, date, time, serviceType: serviceType || 'General' };

Â  Â  Â  Â  // Now that login is strictly enforced at the start, we only need the AJAX confirmation here.
Â  Â  Â  Â  autoConfirmBooking(bookingData);
Â  Â  Â  });

Â  Â  Â  // ğŸ”¹ Function to confirm booking (with AJAX simulation)
Â  Â  Â  function autoConfirmBooking(data) {
Â  Â  Â  Â  Â  const $button = $(".book-btn");
Â  Â  Â  Â  $.ajax({
Â  Â  Â  Â  Â  url: "dummyBookingAPI", // Placeholder
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  data: data,
Â  Â  Â  Â  Â  timeout: 100, 
Â  Â  Â  Â  Â  beforeSend: function () {
Â  Â  Â  Â  Â  Â  $button.text("â³ Processing...").prop("disabled", true);
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  complete: function () {
Â  Â  Â  Â  Â  Â  // Confirmation UI Update
Â  Â  Â  Â  Â  Â  $("#workerName").text(data.worker);
Â  Â  Â  Â  Â  Â  $(".notification-bar").fadeIn();
Â  Â  Â  Â  Â  Â  $("#confirmation").fadeIn();
Â  Â  Â  Â  Â  Â  localStorage.removeItem("pendingBooking");

Â  Â  Â  Â  Â  Â  Â $button.text("Booking Confirmed!").css("background-color", "#4CAF50").prop("disabled", true);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â saveBookingToHistory(data);

Â  Â  Â  Â  Â  Â  // â© Redirect to services page with success flag
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  window.location.href = "ar.html?booking=success";
Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // Function to save booking data to localStorage history
Â  Â  Â  function saveBookingToHistory(booking) {
Â  Â  Â  Â  Â  const historyKey = 'userBookingHistory';
Â  Â  Â  Â  Â  let history = [];
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  history = JSON.parse(localStorage.getItem(historyKey)) || [];
Â  Â  Â  Â  Â  } catch (e) {}
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const newBooking = {
Â  Â  Â  Â  Â  Â  Â  worker: booking.worker,
Â  Â  Â  Â  Â  Â  Â  service: booking.serviceType,
Â  Â  Â  Â  Â  Â  Â  date: booking.date,
Â  Â  Â  Â  Â  Â  Â  time: booking.time,
Â  Â  Â  Â  Â  Â  Â  status: "confirmed",
Â  Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString()
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  history.unshift(newBooking); 
Â  Â  Â  Â  Â  localStorage.setItem(historyKey, JSON.stringify(history));
Â  Â  Â  }
Â  Â  });
Â  </script>

</body>
</html>